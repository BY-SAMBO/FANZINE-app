<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perro Quesabirria | FANZINE Cine &amp; Tex-Mex</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --accent: #8B0000;
      --accent-light: #c0392b;
      --tag-salsa: #c1292e;
      --tag-queso: #d4a017;
      --tag-fresco: #2d8a4e;
      --tag-crunch: #e76f00;
      --tag-base: #6d4c2a;
      --tag-proteina: #c44536;
    }

    body { background: #fff; color: #000; font-family: 'Space Grotesk', sans-serif; line-height: 1.6; overflow-x: hidden; }
    h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; }

    .hero { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; background: #fff; position: relative; }
    .hero-badge { display: inline-block; font-size: 10px; font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; background: var(--accent); color: #fff; border: 2px solid #000; padding: 0.3rem 1.2rem; border-radius: 0; margin-bottom: 1rem; }
    .hero-emoji { font-size: 5rem; margin-bottom: 1rem; line-height: 1.2; }
    .hero h1 { font-size: clamp(3rem, 8vw, 6rem); color: var(--accent); line-height: 1; }
    .hero .tagline { font-size: clamp(1rem, 3vw, 1.3rem); color: #333; margin-top: 0.75rem; font-weight: 600; max-width: 500px; }
    .hero .price { font-size: 2.2rem; font-weight: 700; color: var(--accent); margin-top: 1rem; }

    section { max-width: 800px; margin: 0 auto; padding: 4rem 1.5rem; }
    .section-title { font-size: clamp(2rem, 5vw, 3rem); color: var(--accent); margin-bottom: 0.5rem; text-align: center; }
    .section-subtitle { text-align: center; color: #666; margin-bottom: 2rem; font-size: 0.95rem; }

    .recipe-timeline { position: relative; padding-left: 2rem; }
    .recipe-timeline::before { content: ''; position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 3px; background: #000; }

    .ingredient { position: relative; margin-bottom: 1.5rem; padding: 1.25rem 1.5rem; background: #fff; border: 3px solid #000; border-radius: 0; box-shadow: 4px 4px 0 #000; }
    .ingredient::before { content: ''; position: absolute; left: -1.65rem; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; border-radius: 50%; border: 3px solid #000; background: #fff; }
    .ingredient-header { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.35rem; }
    .ingredient-name { font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; }
    .ingredient-tag { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; padding: 0.15rem 0.6rem; border: 2px solid #000; border-radius: 0; color: #fff; }
    .tag-base { background: var(--tag-base); }
    .tag-salsa { background: var(--tag-salsa); }
    .tag-queso { background: var(--tag-queso); color: #000; }
    .tag-fresco { background: var(--tag-fresco); }
    .tag-crunch { background: var(--tag-crunch); color: #000; }
    .tag-proteina { background: var(--tag-proteina); }
    .ingredient-role { color: #666; font-size: 0.9rem; }

    .meters { display: flex; flex-direction: column; gap: 1.25rem; max-width: 500px; margin: 0 auto; }
    .meter-row { display: flex; align-items: center; gap: 1rem; }
    .meter-label { font-size: 1.1rem; font-weight: 700; min-width: 120px; color: #000; text-transform: uppercase; text-align: right; flex-shrink: 0; }
    .meter-bar-bg { flex: 1; height: 16px; background: #fff; border: 2px solid #000; border-radius: 0; overflow: hidden; }
    .meter-bar-fill { height: 100%; background: var(--accent); }
    .meter-value { font-size: 1rem; font-weight: 700; color: var(--accent); min-width: 28px; text-align: center; }

    .flavor-card { border: 3px solid #000; border-radius: 0; box-shadow: 4px 4px 0 #000; padding: 2rem; font-size: 1.05rem; line-height: 1.75; color: #333; position: relative; overflow: hidden; background: #fff; }
    .flavor-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--accent); }
    .flavor-card p { position: relative; z-index: 1; }
    .flavor-quote { font-size: 5rem; color: var(--accent); opacity: 0.15; position: absolute; top: -0.2rem; left: 1rem; font-family: Georgia, serif; line-height: 1; }

    .lab-notes-card { border: 3px solid #000; border-radius: 0; box-shadow: 4px 4px 0 #000; padding: 1.5rem; background: #fff; }
    .lab-notes { width: 100%; min-height: 120px; background: #fff; border: 2px solid #000; border-radius: 0; padding: 1rem; color: #000; font-family: 'Space Grotesk', sans-serif; font-size: 0.95rem; resize: vertical; }
    .lab-notes:focus { outline: none; border-color: var(--accent); }
    .lab-notes::placeholder { color: #999; }

    footer { text-align: center; padding: 3rem 1.5rem; border-top: 3px solid #000; }
    footer .brand { font-size: 1.6rem; font-weight: 700; color: #000; letter-spacing: 0.1em; text-transform: uppercase; }
    footer a { display: inline-block; margin-top: 0.8rem; color: var(--accent); text-decoration: none; font-weight: 700; font-size: 0.9rem; }
    footer a:hover { color: var(--accent-light); }

    @media (max-width: 600px) {
      .hero-emoji { font-size: 3.5rem; }
      .meter-label { min-width: 90px; font-size: 0.95rem; }
      section { padding: 3rem 1rem; }
    }
  </style>
</head>
<body>

  <header class="hero">
    <div class="hero-emoji">&#127789;&#129754;&#129472;</div>
    <div class="hero-badge">CICLO 1 &mdash; DEGUSTACI&Oacute;N</div>
    <h1>Perro Quesabirria</h1>
    <p class="tagline">La quesabirria hecha hot dog.</p>
    <div class="price">$18,000 COP</div>
  </header>

  <section>
    <h2 class="section-title">La Receta</h2>
    <p class="section-subtitle">De abajo hacia arriba, capa por capa</p>

    <div class="recipe-timeline">

      <div class="ingredient">
        <div class="ingredient-header">
          <span class="ingredient-name">Cebolla Encurtida</span>
          <span class="ingredient-tag tag-fresco">Fresco</span>
        </div>
        <div class="ingredient-role">&Aacute;cido imprescindible que corta la riqueza</div>
      </div>

      <div class="ingredient">
        <div class="ingredient-header">
          <span class="ingredient-name">Salsa de Le&ntilde;a / Mayo Ahumada</span>
          <span class="ingredient-tag tag-salsa">Salsa</span>
        </div>
        <div class="ingredient-role">Profundidad ahumada que amplifica la birria</div>
      </div>

      <div class="ingredient">
        <div class="ingredient-header">
          <span class="ingredient-name">Queso Cheddar Fundido</span>
          <span class="ingredient-tag tag-queso">Queso</span>
        </div>
        <div class="ingredient-role">Referencia directa a la quesabirria</div>
      </div>

      <div class="ingredient">
        <div class="ingredient-header">
          <span class="ingredient-name">Res Birria</span>
          <span class="ingredient-tag tag-proteina">Prote&iacute;na</span>
        </div>
        <div class="ingredient-role">Carne jugosa, umami profundo, el alma del perro</div>
      </div>

      <div class="ingredient">
        <div class="ingredient-header">
          <span class="ingredient-name">Salchicha Envuelta en Tocino</span>
          <span class="ingredient-tag tag-base">Base</span>
        </div>
        <div class="ingredient-role">Ahumado de fondo</div>
      </div>

      <div class="ingredient">
        <div class="ingredient-header">
          <span class="ingredient-name">Pan Brioche Dorado</span>
          <span class="ingredient-tag tag-base">Base</span>
        </div>
        <div class="ingredient-role">Tostado y firme para sostener la birria</div>
      </div>

    </div>
  </section>

  <section>
    <h2 class="section-title">Por Qu&eacute; Funciona</h2>
    <p class="section-subtitle">An&aacute;lisis de palatabilidad</p>

    <div class="meters">
      <div class="meter-row">
        <span class="meter-label">Umami</span>
        <div class="meter-bar-bg"><div class="meter-bar-fill" style="width:100%"></div></div>
        <span class="meter-value">5</span>
      </div>
      <div class="meter-row">
        <span class="meter-label">Crunch</span>
        <div class="meter-bar-bg"><div class="meter-bar-fill" style="width:20%"></div></div>
        <span class="meter-value">1</span>
      </div>
      <div class="meter-row">
        <span class="meter-label">Frescura</span>
        <div class="meter-bar-bg"><div class="meter-bar-fill" style="width:60%"></div></div>
        <span class="meter-value">3</span>
      </div>
      <div class="meter-row">
        <span class="meter-label">Picante</span>
        <div class="meter-bar-bg"><div class="meter-bar-fill" style="width:40%"></div></div>
        <span class="meter-value">2</span>
      </div>
      <div class="meter-row">
        <span class="meter-label">Cremosidad</span>
        <div class="meter-bar-bg"><div class="meter-bar-fill" style="width:80%"></div></div>
        <span class="meter-value">4</span>
      </div>
    </div>
  </section>

  <section>
    <h2 class="section-title">Perfil de Sabor</h2>
    <div class="flavor-card">
      <span class="flavor-quote">&ldquo;</span>
      <p>El Quesabirria toma el fen&oacute;meno de la quesabirria y lo traduce a hot dog sin perder nada. La res birria jugosa se funde con el cheddar derretido mientras la mayo ahumada agrega una capa de humo que amplifica en vez de competir. La cebolla encurtida es el h&eacute;roe silencioso: sin ella, la riqueza abrumar&iacute;a. Con ella, cada mordida pide la siguiente. Es el perro m&aacute;s umami de la carta.</p>
    </div>
  </section>

  <section>
    <h2 class="section-title">NOTAS DEL LAB</h2>
    <div class="lab-notes-card">
      <textarea class="lab-notes" data-key="lab-notes-birria-quesabirria" placeholder="Escribe tus notas sobre esta receta..."></textarea>
    </div>
  </section>

  <footer>
    <div class="brand">FANZINE &mdash; Cine &amp; Tex-Mex</div>
    <a href="/lab/perros-calientes/reconstruccion/ciclo-1/recetas" target="_top">&larr; Volver al men&uacute;</a>
    <a href="/lab/perros-calientes/reconstruccion/ciclo-1" target="_top" style="margin-left: 1rem;">LAB Gastron&oacute;mico &rarr;</a>
  </footer>

  <script>
    (function() {
      var slug = location.pathname.replace(/.*\//, '').replace('.html', '');
      var debounceTimer;

      // Collect all editable data into an object
      function collectData() {
        var d = {};
        document.querySelectorAll('.qty-input').forEach(function(input) {
          if (input.value) d['qty-' + input.dataset.key] = input.value;
        });
        var notesEl = document.getElementById('labNotes') || document.querySelector('.lab-notes');
        if (notesEl && notesEl.value) d['lab-notes'] = notesEl.value;
        return d;
      }

      // Apply data to DOM fields
      function applyData(d) {
        if (!d) return;
        document.querySelectorAll('.qty-input').forEach(function(input) {
          var val = d['qty-' + input.dataset.key];
          if (val) input.value = val;
        });
        var notesEl = document.getElementById('labNotes') || document.querySelector('.lab-notes');
        if (notesEl && d['lab-notes']) notesEl.value = d['lab-notes'];
      }

      // Save to localStorage (instant) + Supabase (debounced)
      function save() {
        var d = collectData();
        localStorage.setItem('lab-recipe-' + slug, JSON.stringify(d));
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          fetch('/api/lab/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slug: slug, data: d })
          }).catch(function() {});
        }, 1500);
      }

      // Load: try Supabase first, fall back to localStorage
      fetch('/api/lab/notes?slug=' + slug)
        .then(function(r) { return r.json(); })
        .then(function(res) {
          if (res.data && Object.keys(res.data).length > 0) {
            applyData(res.data);
            localStorage.setItem('lab-recipe-' + slug, JSON.stringify(res.data));
          } else {
            // Fall back to localStorage
            var local = localStorage.getItem('lab-recipe-' + slug);
            if (local) {
              applyData(JSON.parse(local));
            } else {
              // Try legacy localStorage keys
              document.querySelectorAll('.qty-input').forEach(function(input) {
                var saved = localStorage.getItem('lab-qty-' + input.dataset.key);
                if (saved) input.value = saved;
              });
              var notesEl = document.getElementById('labNotes') || document.querySelector('.lab-notes');
              if (notesEl) {
                var nk = notesEl.dataset.key;
                var saved = localStorage.getItem(nk) || localStorage.getItem('lab-notes-' + nk);
                if (saved) notesEl.value = saved;
              }
            }
          }
        })
        .catch(function() {
          // Offline: use localStorage
          var local = localStorage.getItem('lab-recipe-' + slug);
          if (local) applyData(JSON.parse(local));
        });

      // Bind save on input
      document.querySelectorAll('.qty-input').forEach(function(input) {
        input.addEventListener('input', save);
      });
      var notesEl = document.getElementById('labNotes') || document.querySelector('.lab-notes');
      if (notesEl) notesEl.addEventListener('input', save);

      // PostMessage context bridge for Lab Chat
      window.addEventListener('message', function(e) {
        if (e.data && e.data.type === 'get-recipe-context') {
          var name = document.querySelector('h1') ? document.querySelector('h1').textContent.trim() : '';
          var ingredients = [];
          document.querySelectorAll('.ingredient').forEach(function(el) {
            var n = el.querySelector('.ingredient-name');
            var t = el.querySelector('.ingredient-tag');
            var r = el.querySelector('.ingredient-role');
            var q = el.querySelector('.qty-input');
            ingredients.push((n?n.textContent.trim():'') + ' [' + (t?t.textContent.trim():'') + '] â€” ' + (r?r.textContent.trim():'') + (q?' (qty: '+q.value+')':''));
          });
          var meters = [];
          document.querySelectorAll('.meter-row').forEach(function(el) {
            var l = el.querySelector('.meter-label');
            var v = el.querySelector('.meter-value');
            meters.push((l?l.textContent.trim():'') + ': ' + (v?v.textContent.trim():''));
          });
          var flavor = document.querySelector('.flavor-text') ? document.querySelector('.flavor-text').textContent.trim() : '';
          var tasks = [];
          document.querySelectorAll('.tarea-text').forEach(function(el) { tasks.push(el.textContent.trim()); });
          var notes = '';
          var ne = document.getElementById('labNotes') || document.querySelector('.lab-notes');
          if (ne) notes = ne.value || '';
          var ctx = 'RECETA: ' + name + '\n\nINGREDIENTES:\n' + ingredients.join('\n') + '\n\nMETERS:\n' + meters.join('\n') + '\n\nPERFIL DE SABOR:\n' + flavor;
          if (tasks.length) ctx += '\n\nTAREAS:\n' + tasks.join('\n');
          if (notes) ctx += '\n\nNOTAS DEL LAB:\n' + notes;
          parent.postMessage({ type: 'recipe-context', context: ctx }, '*');
        }
      });
    })();
  </script>

</body>
</html>
